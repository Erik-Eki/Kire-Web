<script lang="ts">
	import { onMount } from 'svelte'
	import { supabase } from '$lib/supabaseClient'
	//import type { AuthSession } from '@supabase/supabase-js'
	//import { currentUserProfile } from '$components/stores/profile'

	export let postID: String

	let comments

	async function getComments() {
		const { data, error } = await supabase
			.from('comments')
			.select(`*, profiles (username)`)
			.eq('post_id', postID)
            .order("created_at", {ascending: false})

		if (error) console.log(error)

		comments = data
	}

	onMount(async () => {
		getComments()

		supabase
			.channel('comment_watchdog')
			.on(
				'postgres_changes',
				{ event: 'INSERT', schema: 'public', table: 'comments' },
				(payload) => {
                    //console.log('New comment!', payload)
					getComments()
				}
			)
			.on(
				'postgres_changes',
				{ event: 'DELETE', schema: 'public', table: 'comments' },
				(payload) => {
                    //console.log('Comment got deleted...', payload)
					getComments()
				}
			)
			.subscribe()

        //console.log("CHANNELS:", supabase.getChannels())
	})
</script>

<div>
	<h2 class="mt-0 pt-0">Comments: {comments ? comments.length : 0}</h2>
	<hr />
	{#if comments}
		<div class="flex flex-col gap-4">
			{#each comments as c}
				<div class="rounded bg-black bg-opacity-50 p-4">
					<div class="flex flex-row items-center gap-4">
						<div class="text-base text-violet-500">{c.profiles.username}</div>
						<div class="text-sm">
							{new Date(c.created_at).toLocaleString('en-FI', {
								dateStyle: 'short',
								timeStyle: 'short'
							})}
						</div>
					</div>

					<p class="pl-4">{c.comment}</p>
					<div class="flex flex-row items-center gap-2">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="1em"
							height="1em"
							viewBox="0 0 24 24"
							{...$$props}
							><path
								fill="currentColor"
								d="M5 9v12H1V9h4m4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21H9m0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03V19Z"
							/></svg
						>
						<div>{c.likes}</div>
						<div class="h-6 border border-l-white"></div>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="1em"
							height="1em"
							viewBox="0 0 24 24"
							{...$$props}
							><path
								fill="currentColor"
								d="M19 15V3h4v12h-4M15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31l.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3h9m0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97V5Z"
							/></svg
						>
						<div>{c.likes}</div>
					</div>
				</div>
			{/each}
		</div>
	{:else}
		<div>Be the first to commment :)</div>
	{/if}
	<hr />
</div>
